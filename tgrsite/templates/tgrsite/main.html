{% extends 'tgrsite/addnavbar.html' %}
{% load static %}
{% load markdown_tags %}

{% comment %}
THIS IS USED BY THE REST OF THE SITE (excluding the newsletter views using the previous templates).
This introduces a generic left bar containing recent threads etc.
{% endcomment %}

{% block leftcontents %}
	<div class="panel panel-default">
		<div class="panel-heading">
			Welcome{% if request.user.is_authenticated %} back{% else %}, guest{% endif %}!
		</div>
		<div class="panel-body">
			<ul>
				{% if request.user.is_staff %}
					<li><a href="/admin">Admin site</a></li>
				{% endif %}
				{%if request.user.is_authenticated %}
					<li><a href="{% url 'me' %}">
						My profile
					</a></li>
					<li><a href="{% url 'logout' %}">Log out</a></li>
				{% else %}
					<li><a href="{% url 'login' %}">Log in</a> / <a href="{% url 'signup' %}">Register</a></li>
				{% endif %}

				<li><a href="{% url 'bug_create' %}">Report a bug</a></li>
			</ul>
		</div>
	</div>
	<div class="panel panel-default accordion" id="recentThreads">
		<div class="panel-heading">
			Recent threads
		</div>
		<div class="panel-body">
		<ul class="nobullet">
			{% for x in latestthreads %}
				<li class="latest">
					<a href="{% url 'viewthread' x.id %}">{{x.title|truncatechars:32}}</a>
					<br>

					<small>
					by <a href="{% url 'user' x.author.id %}">{{x.author.equiv_user.username|truncatechars:32}}</a>
					in <a href="{% url 'subforum' x.forum.id %}">{{x.forum}}</a>
					{{x.pub_date|timesince}} ago
					</small>
				</li>
			{% endfor %}
		</ul>
		</div>
	</div>

	<div class="panel panel-default accordion" id="recentReplies">
		<div class="panel-heading">
			Recent replies
		</div>
		<div class="panel-body">
		<ul class="nobullet">
			{% for x in latestresponses %}
				<li class="latest">
					<a href="{% url 'viewthread' x.thread.id %}#response-{{x.id}}">{{x.body|parse_md|striptags|truncatechars:32}}</a>
					<br>

					<small>
					by <a href="{% url 'user' x.author.id %}">{{x.author.equiv_user.username|truncatechars:32}}</a>
					{{x.pub_date|timesince}} ago
					</small>
				</li>
			{% endfor %}
		</ul>
		</div>
	</div>
	{% block leftbar %}{% endblock %}
{% endblock %}

{% block bottomscripts %}
{{ block.super }}
<script>
$(document).ready(function() {
    console.log("Sticking sidebars.");
    loadStates();
    let threads=$('#recentThreads');
    let replies=$('#recentReplies');
    threads.bind(replies.accordion("option","event"), function (event) {saveState('recentThreads')});
    replies.bind(replies.accordion("option","event"), function (event) {saveState('recentReplies')});
});

function loadStates() {
    let rt=getCookie('recentThreads');
    let rr=getCookie('recentReplies');
    let threads=$('#recentThreads');
    let replies=$('#recentReplies');
    if (rt!=="") {
        threads.accordion("option","animate",false).accordion("option","active",parseInt(rt)).accordion("option","animate",true);
    }
    if (rr!=="") {
        replies.accordion("option", "animate", false).accordion("option", "active", parseInt(rr)).accordion("option", "animate", true);
    }
}
function saveState(key) {
    setCookie(key,$('#'+key).accordion("option","active"),365)
}

//Retreived from https://www.w3schools.com/js/js_cookies.asp 2018-10-11 by Thomas Bruce
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
//end retreived
</script>
{% endblock %}
